/*
{
    'grid': [
        [[null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word]],
        [[null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell]],
        [[null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell]],
        [[null, 2, cell], [null, 2, cell], [null, 2, cell], [null, 2, cell], [null, 2, cell], [null, 2, cell], [null, 2, cell], [null, 2, cell], [null, 2, cell], [null, 2, cell], [null, 2, cell], [null, 2, cell], [null, 2, cell], [null, 2, cell]],
        [[null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell]],
        [[null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell]],
        [[null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell]],
        [[null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word]],
        [[null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell]],
        [[null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell]],
        [[null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell]],
        [[null, 2, cell], [null, 2, cell], [null, 2, cell], [null, 2, cell], [null, 2, cell], [null, 2, cell], [null, 2, cell], [null, 2, cell], [null, 2, cell], [null, 2, cell], [null, 2, cell], [null, 2, cell], [null, 2, cell], [null, 2, cell]],
        [[null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell]],
        [[null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell], [null, 1, cell]],
        [[null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word], [null, 3, word]]
    ],
    'players': [
        [id, login, user_items, points],
        [id, login, user_items, points],
        [id, login, user_items, points],
        [id, login, user_items, points]
    ],
    'status': 'lobby'|'game'|'closed',
    'turn': 1,
    'items': [
        ['а', 3, 5],
        ['б', 3, 5],
        ['в', 3, 5],
        ['г', 3, 5],
        ['д', 3, 5],
        ['е', 3, 5],
        ['ё', 3, 5],
        ['ж', 3, 5],
        ['з', 3, 5],
        ['и', 3, 5],
        ['й', 3, 5],
        ['к', 3, 5],
        ['л', 3, 5],
        ['м', 3, 5],
        ['н', 3, 5],
        ['о', 3, 5],
        ['п', 3, 5],
        ['р', 3, 5],
        ['с', 3, 5],
        ['т', 3, 5],
        ['у', 3, 5],
        ['ф', 3, 5],
        ['х', 3, 5],
        ['ц', 3, 5],
        ['ч', 3, 5],
        ['ш', 3, 5],
        ['щ', 3, 5],
        ['ъ', 3, 5],
        ['ы', 3, 5],
        ['ь', 3, 5],
        ['э', 3, 5],
        ['ю', 3, 5],
        ['я', 3, 5]
    ]
}
user_items = {
    'А': 3,
    'Б': 1,
    'В': 2,
    'Г': 1
}
*/

document.addEventListener("DOMContentLoaded", async () => {
    let temp = window.location.search.substring(1).split(":");
    let link = temp[0];
    let login = temp[1];
    await connectUser(link, login)
        .then((doesConnected) => {
            console.log(doesConnected);
            if(!doesConnected) {
                alert("Пользователя не существует, либо он находится в игре!");
            }
            else {
                gameInfo(link).then((data) => {
                    if(data) {
                        startGame(data);
                    }
                });
            }
        });
});

async function connectUser(link, login) {
    console.log(link, login);
    let formData = new FormData();
    formData.append('link', link);
    formData.append('login', login);
    formData.append('data', 'players');
    let url = "http://tabletop/php/changeData.php";
    let promise = await fetch(url, {
        method: 'POST',
        body: formData
    });
    return await promise.json();
}


function startGame(data) {
    console.log(data);
    let w = 1000;
    let h = 900;
    let canvas = document.querySelector(".canvas");
    let ctx = canvas.getContext('2d');
    let ball = new Ball(20);
    document.addEventListener("mousedown", ball.move.bind(ball));
    setInterval(draw.bind(this, canvas, ctx, ball, w, h), 10);
}

async function gameInfo(link) {
    let formData = new FormData();
    formData.append('link', link);
    let url = "http://tabletop/php/getData.php";
    let response = await fetch(url, {
        method: 'POST',
        body: formData
    });
    return await response.json();
}

function Ball(Radius) {
    this.x = 25;
    this.y = 25;
    this.r = Radius;
}

Ball.prototype.move = function (e) {
    if(
        e.x >= this.x - this.r &&
        e.x <= this.x + this.r &&
        e.y >= this.y - this.r &&
        e.y <= this.y + this.r
    ) {
        let handler = mouseMoveEvent.bind(this);
        document.addEventListener("mousemove", handler);
        document.addEventListener("mouseup", mouseUpEvent.bind(this, handler), {once: true});
    }
};

let mouseUpEvent = function (handler) {
    this.r = 20;
    document.removeEventListener("mousemove", handler);
};

let mouseMoveEvent = function (e) {
    this.r = 25;
    if(e.y < 800 && e.x > 0 && e.x < 1000) {
        this.x = Math.floor(e.x / 50) * 50 + 25;
        this.y = Math.floor(e.y / 50) * 50 + 25;
    }
    else if(e.y < 875 && e.x > 25 && e.x < 975){
        this.x = e.x;
        this.y = e.y;
    }
};

function draw(canvas, ctx, ball, w, h) {
    ctx.canvas.width  = w;
    ctx.canvas.height = h;
    ctx.clearRect(0, 0, w, h);
    drawGrid(ctx, w, h);
    drawBall(ctx, ball);
}

function drawGrid(ctx, w, h) {
    for (let x=0; x<=w; x+=50) {
        ctx.moveTo(x, 0);
        ctx.lineTo(x, h - 100);
        ctx.stroke();
    }
    for (let y=0; y<=h - 100; y+=50) {
        ctx.moveTo(0, y);
        ctx.lineTo(w, y);
        ctx.stroke();
    }
}

function drawBall(ctx, ball) {
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ball.r, 0, 2 * Math.PI, false);
    ctx.lineWidth = 3;
    ctx.strokeStyle = '#FF0000';
    ctx.stroke();
}